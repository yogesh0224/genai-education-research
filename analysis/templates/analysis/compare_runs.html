<!DOCTYPE html>
<html>
<head>
  <title>Run Comparison</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

</head>
<body>

<h1>Run Comparison</h1>

<form method="get" style="margin-bottom: 14px;">
  <label><b>Assignment ID filter:</b></label>
  <input type="text" name="assignment_id" value="{{ assignment_id }}" />
  <button type="submit">Filter</button>
  <a href="{% url 'analysis:compare_runs' %}">Clear</a>
</form>

{% if rows %}
  {% for row in rows %}
    <hr/>
    <h3>{{ row.assignment_display }}</h3>

    <p>
      <b>Run:</b> {{ row.run.id }} |
      <b>Status:</b> {{ row.run.status }} |
      <b>Created:</b>
      {% if row.run.created_at %}
        {{ row.run.created_at }}
      {% else %}
        {{ row.run.started_at }}
      {% endif %}
      |
      <a href="{% url 'analysis:run_dashboard' row.run.id %}" target="_blank">Open Dashboard</a>
    </p>

    {% if row.artifacts %}
      <table border="1" cellpadding="8">
        <tr>
          <th>Model</th>
          <th>Target</th>
          <th>R² (mean ± std)</th>
          <th>RMSE (mean ± std)</th>
          <th>MAE (mean ± std)</th>
          <th>Artifact created</th>
        </tr>

        {% for a in row.artifacts %}
          <tr {% if a.is_best %}style="background:#d9ffd9;"{% endif %}>
            <td>
              {{ a.model }}
              {% if a.is_best %}
                <b style="color:green;">(BEST)</b>
              {% endif %}
            </td>
            <td>{{ a.target }}</td>

            <td>
              {% if a.r2_mean is not None %}
                {{ a.r2_mean|floatformat:3 }} ± {{ a.r2_std|floatformat:3 }}
              {% else %}
                —
              {% endif %}
            </td>

            <td>
              {% if a.rmse_mean is not None %}
                {{ a.rmse_mean|floatformat:3 }} ± {{ a.rmse_std|floatformat:3 }}
              {% else %}
                —
              {% endif %}
            </td>

            <td>
              {% if a.mae_mean is not None %}
                {{ a.mae_mean|floatformat:3 }} ± {{ a.mae_std|floatformat:3 }}
              {% else %}
                —
              {% endif %}
            </td>

            <td>{{ a.created_at }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No artifacts found for this run.</p>
    {% endif %}

  {% endfor %}
{% else %}
  <p>No runs found.</p>
{% endif %}

<hr/>
<h2>Run Comparison Plot (CV R² mean over time)</h2>

{% if plot_points %}
  <div id="r2Plot" style="width:100%; max-width:1100px; height:520px;"></div>

  {{ plot_points|json_script:"plot-data" }}

  <script>
    const points = JSON.parse(document.getElementById("plot-data").textContent);

    // Group points by series (model:target)
    const bySeries = {};
    for (const p of points) {
      if (!bySeries[p.series]) bySeries[p.series] = [];
      bySeries[p.series].push(p);
    }

    // Sort each series by time
    for (const s in bySeries) {
      bySeries[s].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }

    // Build traces
    const traces = Object.keys(bySeries).sort().map(seriesName => {
      const arr = bySeries[seriesName];
      return {
        name: seriesName,
        x: arr.map(p => p.timestamp),
        y: arr.map(p => p.r2_mean),
        mode: "lines+markers",
        type: "scatter",
        hoverinfo: "text",
        text: arr.map(p => (
          `Series: ${p.series}<br>` +
          `Run: ${p.run_id}<br>` +
          `R² mean: ${p.r2_mean}` +
          (p.r2_std != null ? `<br>R² std: ${p.r2_std}` : "") +
          `<br>Time: ${p.timestamp}`
        ))
      };
    });

    const layout = {
      title: "CV R² mean over time",
      xaxis: { title: "Run time", type: "date" },
      yaxis: { title: "R² mean", rangemode: "tozero" },
      hovermode: "closest",
      legend: { orientation: "h" }
    };

    Plotly.newPlot("r2Plot", traces, layout);
  </script>
{% else %}
  <p>No plot data found yet (no artifacts with CV metrics).</p>
{% endif %}


</body>
</html>
